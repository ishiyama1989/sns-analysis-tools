<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ <%= year %>å¹´<%= month %>æœˆ - Instagramé‹ç”¨åˆ†æ</title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h1>
      <nav>
        <a href="/" class="btn btn-link">ãƒ›ãƒ¼ãƒ </a>
        <a href="/posts" class="btn btn-link">æŠ•ç¨¿ä¸€è¦§</a>
        <a href="/analytics" class="btn btn-link">åˆ†æ</a>
        <a href="/goals" class="btn btn-link">ç›®æ¨™è¨­å®š</a>
      </nav>
    </header>
    
    <main>
      <div class="report-header">
        <div class="report-title">
          <h2><%= year %>å¹´<%= month %>æœˆ é‹ç”¨ãƒ¬ãƒãƒ¼ãƒˆ</h2>
          <div class="report-actions">
            <form class="month-selector" method="GET">
              <select name="year" onchange="this.form.submit()">
                <% for (let i = 2024; i <= new Date().getFullYear(); i++) { %>
                  <option value="<%= i %>" <%= year === i ? 'selected' : '' %>><%= i %>å¹´</option>
                <% } %>
              </select>
              <select name="month" onchange="this.form.submit()">
                <% for (let i = 1; i <= 12; i++) { %>
                  <option value="<%= i %>" <%= month === i ? 'selected' : '' %>><%= i %>æœˆ</option>
                <% } %>
              </select>
            </form>
            <a href="/reports/pdf?year=<%= year %>&month=<%= month %>" class="btn btn-primary" target="_blank">
              ğŸ“„ PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </a>
          </div>
        </div>
      </div>

      <% if (reportData.summary.totalPosts > 0) { %>
        <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼ -->
        <div class="report-section">
          <h3>ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼</h3>
          <div class="report-summary-grid">
            <div class="summary-card large">
              <div class="summary-icon">ğŸ“ˆ</div>
              <div class="summary-content">
                <div class="summary-number"><%= reportData.summary.totalPosts %></div>
                <div class="summary-label">ç·æŠ•ç¨¿æ•°</div>
              </div>
            </div>
            
            <div class="summary-card large">
              <div class="summary-icon">â¤ï¸</div>
              <div class="summary-content">
                <div class="summary-number"><%= reportData.summary.totalLikes.toLocaleString() %></div>
                <div class="summary-label">ç·ã„ã„ã­æ•°</div>
              </div>
            </div>
            
            <div class="summary-card large">
              <div class="summary-icon">ğŸ’¬</div>
              <div class="summary-content">
                <div class="summary-number"><%= reportData.summary.totalComments.toLocaleString() %></div>
                <div class="summary-label">ç·ã‚³ãƒ¡ãƒ³ãƒˆæ•°</div>
              </div>
            </div>
            
            <div class="summary-card large">
              <div class="summary-icon">ğŸ”–</div>
              <div class="summary-content">
                <div class="summary-number"><%= reportData.summary.totalSaves.toLocaleString() %></div>
                <div class="summary-label">ç·ä¿å­˜æ•°</div>
              </div>
            </div>
            
            <div class="summary-card large">
              <div class="summary-icon">âš¡</div>
              <div class="summary-content">
                <div class="summary-number"><%= reportData.summary.avgEngagement.toLocaleString() %></div>
                <div class="summary-label">å¹³å‡ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</div>
              </div>
            </div>
            
            <div class="summary-card large">
              <div class="summary-icon">ğŸ‘¥</div>
              <div class="summary-content">
                <div class="summary-number <%= reportData.summary.followersGrowth >= 0 ? 'positive' : 'negative' %>">
                  <%= reportData.summary.followersGrowth >= 0 ? '+' : '' %><%= reportData.summary.followersGrowth %>%
                </div>
                <div class="summary-label">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æˆé•·ç‡</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ¨ç§»ã‚°ãƒ©ãƒ• -->
        <div class="report-section">
          <h3>ğŸ‘¥ ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°æ¨ç§»</h3>
          <div class="follower-charts-container">
            <div class="chart-section">
              <div class="chart-header">
                <h4>é€±æ¬¡ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å¢—åŠ æ•°</h4>
                <p class="chart-description">1é€±é–“ã”ã¨ã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å¢—åŠ æ•°</p>
              </div>
              <div class="chart-container">
                <canvas id="weeklyGrowthChart"></canvas>
              </div>
            </div>
            
            <div class="chart-section">
              <div class="chart-header">
                <h4>ç·ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°æ¨ç§»</h4>
                <p class="chart-description">æœˆå†…ã®ç·ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã®å¤‰åŒ–</p>
              </div>
              <div class="chart-container">
                <canvas id="totalFollowersChart"></canvas>
              </div>
            </div>
          </div>
          
          <!-- ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å±¥æ­´å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
          <div class="follower-input-section">
            <h4>ğŸ“ ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã‚’è¨˜éŒ²</h4>
            <form class="follower-input-form" action="/follower-history" method="POST">
              <div class="input-group">
                <label for="date">æ—¥ä»˜</label>
                <input type="date" id="date" name="date" required>
              </div>
              <div class="input-group">
                <label for="followers_count">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°</label>
                <input type="number" id="followers_count" name="followers_count" min="0" placeholder="ä¾‹: 1250" required>
              </div>
              <button type="submit" class="btn btn-success">è¨˜éŒ²ã‚’è¿½åŠ </button>
            </form>
          </div>
        </div>

        <!-- ãƒ™ã‚¹ãƒˆæŠ•ç¨¿ -->
        <% if (reportData.summary.bestPost) { %>
          <div class="report-section">
            <h3>ğŸ† ä»Šæœˆã®ãƒ™ã‚¹ãƒˆæŠ•ç¨¿</h3>
            <div class="best-post-card">
              <div class="best-post-info">
                <div class="best-post-date">
                  <%= reportData.summary.bestPost.post_date %> <%= reportData.summary.bestPost.post_time %>
                </div>
                <div class="best-post-type">
                  <%= reportData.summary.bestPost.post_type === 'image' ? 'ğŸ“· ç”»åƒ' : 
                      reportData.summary.bestPost.post_type === 'reel' ? 'ğŸ¬ ãƒªãƒ¼ãƒ«' : 'ğŸ“– ã‚¹ãƒˆãƒ¼ãƒªãƒ¼' %>
                </div>
              </div>
              <div class="best-post-stats">
                <span class="stat">â¤ï¸ <%= (reportData.summary.bestPost.likes || 0).toLocaleString() %></span>
                <span class="stat">ğŸ’¬ <%= (reportData.summary.bestPost.comments || 0).toLocaleString() %></span>
                <span class="stat">ğŸ”– <%= (reportData.summary.bestPost.saves || 0).toLocaleString() %></span>
              </div>
              <% if (reportData.summary.bestPost.caption) { %>
                <div class="best-post-caption">
                  "<%= reportData.summary.bestPost.caption.substring(0, 100) %><%= reportData.summary.bestPost.caption.length > 100 ? '...' : '' %>"
                </div>
              <% } %>
            </div>
          </div>
        <% } %>

        <!-- ã‚¤ãƒ³ã‚µã‚¤ãƒˆ -->
        <div class="report-section">
          <h3>ğŸ’¡ ä»Šæœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h3>
          <div class="insights-container">
            <% reportData.insights.forEach((insight, index) => { %>
              <div class="insight-item">
                <div class="insight-number"><%= index + 1 %></div>
                <div class="insight-text"><%= insight %></div>
              </div>
            <% }) %>
          </div>
        </div>

        <!-- æ”¹å–„ææ¡ˆ -->
        <div class="report-section">
          <h3>ğŸš€ æ”¹å–„ææ¡ˆ</h3>
          <div class="recommendations-container">
            <% reportData.recommendations.forEach((recommendation, index) => { %>
              <div class="recommendation-item">
                <div class="recommendation-icon">ğŸ’¡</div>
                <div class="recommendation-text"><%= recommendation %></div>
              </div>
            <% }) %>
          </div>
        </div>

        <!-- æŠ•ç¨¿ä¸€è¦§ï¼ˆã‚µãƒãƒªãƒ¼ï¼‰ -->
        <div class="report-section">
          <h3>ğŸ“ ä»Šæœˆã®æŠ•ç¨¿ä¸€è¦§</h3>
          <div class="posts-summary-table">
            <div class="posts-header">
              <span>æ—¥æ™‚</span>
              <span>ã‚¿ã‚¤ãƒ—</span>
              <span>ã„ã„ã­</span>
              <span>ã‚³ãƒ¡ãƒ³ãƒˆ</span>
              <span>ä¿å­˜</span>
              <span>ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</span>
            </div>
            <% reportData.posts.slice(0, 10).forEach(post => { %>
              <div class="post-summary-row">
                <span class="post-date"><%= post.post_date %> <%= post.post_time %></span>
                <span class="post-type">
                  <%= post.post_type === 'image' ? 'ğŸ“·' : post.post_type === 'reel' ? 'ğŸ¬' : 'ğŸ“–' %>
                </span>
                <span class="post-stat"><%= (post.likes || 0).toLocaleString() %></span>
                <span class="post-stat"><%= (post.comments || 0).toLocaleString() %></span>
                <span class="post-stat"><%= (post.saves || 0).toLocaleString() %></span>
                <span class="post-engagement">
                  <%= ((post.likes || 0) + (post.comments || 0) + (post.saves || 0)).toLocaleString() %>
                </span>
              </div>
            <% }) %>
            <% if (reportData.posts.length > 10) { %>
              <div class="posts-more">
                ä»– <%= reportData.posts.length - 10 %> ä»¶ã®æŠ•ç¨¿
              </div>
            <% } %>
          </div>
        </div>

      <% } else { %>
        <div class="no-data-message">
          <h2><%= year %>å¹´<%= month %>æœˆã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h2>
          <p>ã“ã®æœˆã«æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ãŒã¾ã å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
          <div class="report-actions">
            <a href="/add-post" class="btn btn-primary">æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ </a>
            <form class="month-selector" method="GET" style="margin-top: 1rem;">
              <label>ä»–ã®æœˆã‚’è¡¨ç¤º:</label>
              <select name="year" onchange="this.form.submit()">
                <% for (let i = 2024; i <= new Date().getFullYear(); i++) { %>
                  <option value="<%= i %>" <%= year === i ? 'selected' : '' %>><%= i %>å¹´</option>
                <% } %>
              </select>
              <select name="month" onchange="this.form.submit()">
                <% for (let i = 1; i <= 12; i++) { %>
                  <option value="<%= i %>" <%= month === i ? 'selected' : '' %>><%= i %>æœˆ</option>
                <% } %>
              </select>
            </form>
          </div>
        </div>
      <% } %>
    </main>
  </div>

  <script>
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚°ãƒ©ãƒ•ã‚’åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      <% if (reportData.summary.totalPosts > 0) { %>
        initializeFollowerCharts();
      <% } %>
    });

    async function initializeFollowerCharts() {
      try {
        const response = await fetch('/api/follower-chart-data?year=<%= year %>&month=<%= month %>');
        const data = await response.json();
        
        if (data.followerGrowth && data.weeklyGrowthData) {
          createWeeklyGrowthChart(data.weeklyGrowthData);
          createTotalFollowersChart(data.followerGrowth);
        }
      } catch (error) {
        console.error('ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      }
    }

    // é€±æ¬¡ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å¢—åŠ æ•°ã‚°ãƒ©ãƒ•ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
    function createWeeklyGrowthChart(data) {
      const ctx = document.getElementById('weeklyGrowthChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'é€±æ¬¡ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å¢—åŠ æ•°',
            data: data.data,
            backgroundColor: data.data.map(value => 
              value >= 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
            ),
            borderColor: data.data.map(value => 
              value >= 0 ? '#28a745' : '#dc3545'
            ),
            borderWidth: 2,
            borderRadius: 6,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  return `${value >= 0 ? '+' : ''}${value} ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return value >= 0 ? '+' + value : value;
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // ç·ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆç·šã‚°ãƒ©ãƒ•ï¼‰
    function createTotalFollowersChart(data) {
      const ctx = document.getElementById('totalFollowersChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'ç·ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°',
            data: data.totalFollowers,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#667eea',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.parsed.y.toLocaleString()} ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>