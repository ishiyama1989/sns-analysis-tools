<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ - SNSé‹ç”¨ä»£è¡Œç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .report-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .report-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .report-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    @media (max-width: 1200px) {
      .metrics-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
    }

    @media (max-width: 480px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .metric-card {
      background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 15px 10px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #e2e8f0;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .metric-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2d3748;
      line-height: 1.2;
    }
    
    .metric-label {
      color: #718096;
      font-size: 0.8rem;
      margin-top: 5px;
      line-height: 1.2;
    }

    @media (max-width: 768px) {
      .metric-value {
        font-size: 1.3rem;
      }
      .metric-label {
        font-size: 0.7rem;
      }
    }
    
    .chart-container {
      height: 300px;
      margin: 20px 0;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 25px;
      margin: 25px 0;
    }

    .charts-grid.two-charts {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr;
    }

    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    .chart-card h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 10px;
      text-align: center;
    }

    .chart-card .chart-container {
      height: 400px;
      margin: 15px 0 0 0;
    }

    @media (max-width: 768px) {
      .charts-grid,
      .charts-grid.two-charts {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(2, 1fr);
        gap: 20px;
      }
      .chart-card .chart-container {
        height: 350px;
      }
    }
    
    .print-btn {
      background: #4299e1;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .print-btn:hover {
      background: #3182ce;
    }
    
    .month-selector {
      background: #f7fafc;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
    }
    
    @media print {
      .no-print {
        display: none;
      }
      .report-section {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="report-container">
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="no-print mb-6">
      <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-md">
        <div class="flex items-center gap-3">
          <a href="/" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
            ğŸ  ãƒ›ãƒ¼ãƒ 
          </a>
          <a href="/companies/<%= company.id %>" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors">
            ğŸ¢ ä¼æ¥­è©³ç´°
          </a>
          <a href="#" onclick="navigateToDataInput()" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">
            ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›
          </a>
          <a href="#" onclick="navigateToAnalytics()" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors">
            ğŸ“Š åˆ†æ
          </a>
        </div>
        <h1 class="text-xl font-bold text-gray-800">ğŸ“Š æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ</h1>
      </div>
    </nav>

    <!-- æœˆé¸æŠ -->
    <div class="month-selector no-print">
      <h3 class="text-lg font-bold mb-4">ğŸ“… ãƒ¬ãƒãƒ¼ãƒˆå¯¾è±¡æœˆé¸æŠ</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <div>
          <label for="yearSelect" class="block text-sm font-semibold text-gray-700 mb-2">å¹´</label>
          <select id="yearSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 bg-white">
            <% for(let y = 2020; y <= new Date().getFullYear() + 1; y++) { %>
              <option value="<%= y %>" <%= y === year ? 'selected' : '' %>><%= y %>å¹´</option>
            <% } %>
          </select>
        </div>
        <div>
          <label for="monthSelect" class="block text-sm font-semibold text-gray-700 mb-2">æœˆ</label>
          <select id="monthSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 bg-white">
            <% for(let m = 1; m <= 12; m++) { %>
              <option value="<%= m %>" <%= m === month ? 'selected' : '' %>><%= m %>æœˆ</option>
            <% } %>
          </select>
        </div>
        <div>
          <button id="generateReport" class="w-full px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">
            ğŸ“ˆ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          </button>
        </div>
        <div>
          <button id="printReport" class="print-btn w-full">
            ğŸ–¨ï¸ å°åˆ·ãƒ»PDFä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <!-- ãƒ¬ãƒãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="report-header">
      <h1 class="text-3xl font-bold mb-2">ğŸ“Š SNSé‹ç”¨æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h1>
      <div class="text-2xl font-bold opacity-95 mb-2"><%= company.company_name %> æ§˜</div>
      <div class="text-lg opacity-90">
        <span><%= year %>å¹´<%= month %>æœˆåº¦ã€€ãƒ»ã€€ä½œæˆæ—¥: <%= new Date().toLocaleDateString('ja-JP') %></span>
      </div>
    </div>

    <!-- ä¼æ¥­æƒ…å ±ã‚µãƒãƒªãƒ¼ -->
    <div class="report-section">
      <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ¢ ä¼æ¥­æƒ…å ±</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
        <div><strong>ä¼æ¥­å:</strong> <%= company.company_name %></div>
        <div><strong>æ¥­ç•Œ:</strong> <%= company.industry %></div>
        <div><strong>é‹ç”¨é–‹å§‹:</strong> <%= company.start_date %></div>
        <div><strong>é–‹å§‹æ™‚ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°:</strong> <%= company.initial_followers.toLocaleString() %>äºº</div>
      </div>
    </div>

    <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¦‚è¦ -->
    <div class="report-section">
      <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ“ˆ ä»Šæœˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¦‚è¦</h2>
      <div class="metrics-grid" id="metricsGrid">
        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
      </div>
    </div>

    <!-- æŠ•ç¨¿ä¸€è¦§ -->
    <div class="report-section">
      <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ“ æŠ•ç¨¿è©³ç´°</h2>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-gray-300" id="postsTable">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 px-4 py-2">æ—¥ä»˜</th>
              <th class="border border-gray-300 px-4 py-2">æŠ•ç¨¿å</th>
              <th class="border border-gray-300 px-4 py-2">ã‚¸ãƒ£ãƒ³ãƒ«</th>
              <th class="border border-gray-300 px-4 py-2">ã„ã„ã­æ•°</th>
              <th class="border border-gray-300 px-4 py-2">ä¿å­˜æ•°</th>
              <th class="border border-gray-300 px-4 py-2">ãƒªãƒ¼ãƒæ•°</th>
              <th class="border border-gray-300 px-4 py-2">æ–°ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</th>
            </tr>
          </thead>
          <tbody>
            <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ2ã¤ã®ãƒãƒ£ãƒ¼ãƒˆï¼‰ -->
    <div class="report-section">
      <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ“Š ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
      <div class="charts-grid two-charts">
        <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¨ç§» -->
        <div class="chart-card">
          <h3>ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¨ç§»</h3>
          <div class="chart-container">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>

        <!-- ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°æ¨ç§» -->
        <div class="chart-card">
          <h3>ğŸ‘¥ ç´¯ç©ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°æ¨ç§»</h3>
          <div class="chart-container">
            <canvas id="followerChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ç”¨èªèª¬æ˜ -->
    <div class="report-section">
      <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ“– ç”¨èªèª¬æ˜</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæ•°ã®èª¬æ˜ -->
        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
          <h3 class="font-bold text-blue-800 mb-2 flex items-center">
            <span class="text-xl mr-2">ğŸ’</span>
            ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæ•°ã¨ã¯ï¼Ÿ
          </h3>
          <p class="text-blue-700 text-sm leading-relaxed">
            æŠ•ç¨¿ã«å¯¾ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®<strong>åå¿œã®ç·æ•°</strong>ã‚’æŒ‡ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®åˆè¨ˆå€¤ã§ã™ï¼š
          </p>
          <ul class="text-blue-700 text-sm mt-2 ml-4 space-y-1">
            <li>â€¢ <strong>ã„ã„ã­æ•°</strong>ï¼šæŠ•ç¨¿ã‚’æ°—ã«å…¥ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ•°</li>
            <li>â€¢ <strong>ã‚³ãƒ¡ãƒ³ãƒˆæ•°</strong>ï¼šæŠ•ç¨¿ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ•°</li>
            <li>â€¢ <strong>ä¿å­˜æ•°</strong>ï¼šå¾Œã§è¦‹è¿”ã™ãŸã‚ã«ä¿å­˜ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ•°</li>
            <li>â€¢ <strong>ã‚·ã‚§ã‚¢æ•°</strong>ï¼šæŠ•ç¨¿ã‚’ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚·ã‚§ã‚¢ã—ãŸæ•°</li>
          </ul>
          <p class="text-blue-600 text-xs mt-3 font-medium">
            ğŸ’¡ ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡ãŒé«˜ã„ã»ã©ã€ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã¨ã®é–¢ä¿‚æ€§ãŒè‰¯å¥½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™
          </p>
        </div>

        <!-- ãƒªãƒ¼ãƒæ•°ã®èª¬æ˜ -->
        <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
          <h3 class="font-bold text-green-800 mb-2 flex items-center">
            <span class="text-xl mr-2">ğŸ‘€</span>
            ãƒªãƒ¼ãƒæ•°ã¨ã¯ï¼Ÿ
          </h3>
          <p class="text-green-700 text-sm leading-relaxed">
            æŠ•ç¨¿ã‚’<strong>å®Ÿéš›ã«è¦‹ãŸãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</strong>ã‚’æŒ‡ã—ã¾ã™ã€‚åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½•åº¦è¦‹ã¦ã‚‚1äººã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™ï¼š
          </p>
          <ul class="text-green-700 text-sm mt-2 ml-4 space-y-1">
            <li>â€¢ <strong>ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒªãƒ¼ãƒ</strong>ï¼šãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®ä¸­ã§æŠ•ç¨¿ã‚’è¦‹ãŸäººæ•°</li>
            <li>â€¢ <strong>éãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒªãƒ¼ãƒ</strong>ï¼šãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ä»¥å¤–ã§æŠ•ç¨¿ã‚’è¦‹ãŸäººæ•°</li>
            <li>â€¢ <strong>ãƒªãƒ¼ãƒçµŒè·¯</strong>ï¼šãƒ•ã‚£ãƒ¼ãƒ‰ã€ç™ºè¦‹ã‚¿ãƒ–ã€ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°æ¤œç´¢ãªã©</li>
          </ul>
          <p class="text-green-600 text-xs mt-3 font-medium">
            ğŸ’¡ éãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒªãƒ¼ãƒãŒå¤šã„ã»ã©ã€æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®éœ²å‡ºãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™
          </p>
        </div>

        <!-- ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³æ•°ã¨ã®é•ã„ -->
        <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500 md:col-span-2">
          <h3 class="font-bold text-yellow-800 mb-2 flex items-center">
            <span class="text-xl mr-2">ğŸ”</span>
            ãƒªãƒ¼ãƒæ•°ã¨ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³æ•°ã®é•ã„
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <h4 class="font-semibold text-yellow-800 mb-1">ğŸ“Š ãƒªãƒ¼ãƒæ•°ï¼ˆReachï¼‰</h4>
              <p class="text-yellow-700">æŠ•ç¨¿ã‚’è¦‹ãŸ<strong>ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</strong></p>
              <p class="text-yellow-600 text-xs mt-1">åŒã˜äººãŒä½•åº¦è¦‹ã¦ã‚‚1ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ</p>
            </div>
            <div>
              <h4 class="font-semibold text-yellow-800 mb-1">ğŸ‘ï¸ ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³æ•°ï¼ˆImpressionsï¼‰</h4>
              <p class="text-yellow-700">æŠ•ç¨¿ãŒè¡¨ç¤ºã•ã‚ŒãŸ<strong>ç·å›æ•°</strong></p>
              <p class="text-yellow-600 text-xs mt-1">åŒã˜äººãŒ2å›è¦‹ãŸã‚‰2ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç·è©•ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ -->
    <div class="report-section">
      <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ’­ ä»Šæœˆã®ç·è©•</h2>
      <div id="summaryComments" class="space-y-3">
        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
      </div>
    </div>

    <!-- æ¥æœˆã®æŠ•ç¨¿ææ¡ˆ -->
    <div class="report-section">
      <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸš€ æ¥æœˆã®æŠ•ç¨¿ææ¡ˆ</h2>
      <div id="nextMonthSuggestions" class="space-y-4">
        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <div class="report-section text-center text-gray-600">
      <p class="text-sm">ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ SNSé‹ç”¨ä»£è¡Œç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ</p>
      <p class="text-xs mt-1">Generated on <%= new Date().toISOString() %></p>
    </div>
  </div>

  <script>
    let currentPosts = [];
    
    document.addEventListener('DOMContentLoaded', function() {
      loadReportData();
    });

    document.getElementById('generateReport').addEventListener('click', loadReportData);
    document.getElementById('printReport').addEventListener('click', function() {
      window.print();
    });

    async function loadReportData() {
      const year = document.getElementById('yearSelect').value;
      const month = document.getElementById('monthSelect').value;
      const company = '<%= company.id %>';

      try {
        const response = await fetch(`/api/posts-grid?year=${year}&month=${month}&company=${company}`);
        const posts = await response.json();
        
        currentPosts = posts;
        generateMetrics(posts);
        generatePostsTable(posts);
        generateCharts(posts);
        generateSummary(posts);
        generateNextMonthSuggestions(posts);
        
      } catch (error) {
        console.error('ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function generateMetrics(posts) {
      const totalPosts = posts.length;
      const totalLikes = posts.reduce((sum, post) => sum + (post.likes || 0), 0);
      const totalSaves = posts.reduce((sum, post) => sum + (post.saves || 0), 0);
      const totalReach = posts.reduce((sum, post) => sum + (post.reachTotal || 0), 0);
      const totalNewFollowers = posts.reduce((sum, post) => sum + (post.newFollowers || 0), 0);
      const avgEngagement = totalPosts > 0 ? Math.round((totalLikes + totalSaves) / totalPosts) : 0;

      const metricsHtml = `
        <div class="metric-card">
          <div class="metric-value">${totalPosts}</div>
          <div class="metric-label">æŠ•ç¨¿æ•°</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${totalLikes.toLocaleString()}</div>
          <div class="metric-label">ã„ã„ã­ç·æ•°</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${totalSaves.toLocaleString()}</div>
          <div class="metric-label">ä¿å­˜ç·æ•°</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${totalReach.toLocaleString()}</div>
          <div class="metric-label">ãƒªãƒ¼ãƒç·æ•°</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${totalNewFollowers.toLocaleString()}</div>
          <div class="metric-label">æ–°ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${avgEngagement.toLocaleString()}</div>
          <div class="metric-label">å¹³å‡ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</div>
        </div>
      `;
      
      document.getElementById('metricsGrid').innerHTML = metricsHtml;
    }

    function generatePostsTable(posts) {
      const tbody = document.querySelector('#postsTable tbody');
      tbody.innerHTML = posts.map(post => `
        <tr>
          <td class="border border-gray-300 px-4 py-2">${post.date}</td>
          <td class="border border-gray-300 px-4 py-2">${post.title || 'æŠ•ç¨¿'}</td>
          <td class="border border-gray-300 px-4 py-2">${post.genre}</td>
          <td class="border border-gray-300 px-4 py-2 text-right">${(post.likes || 0).toLocaleString()}</td>
          <td class="border border-gray-300 px-4 py-2 text-right">${(post.saves || 0).toLocaleString()}</td>
          <td class="border border-gray-300 px-4 py-2 text-right">${(post.reachTotal || 0).toLocaleString()}</td>
          <td class="border border-gray-300 px-4 py-2 text-right">${(post.newFollowers || 0).toLocaleString()}</td>
        </tr>
      `).join('');
    }

    function generateCharts(posts) {
      // ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’ç¢ºèª
      console.log('Posts data for charts:', posts);
      if (posts.length > 0) {
        console.log('First post data:', posts[0]);
        console.log('Keys:', Object.keys(posts[0]));
      }

      // æŠ•ç¨¿ã‚¿ã‚¤ãƒ—åˆ¥ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°
      const postTypeColors = {
        'ãƒ•ã‚£ãƒ¼ãƒ‰': '#4299e1',      // é’
        'ãƒªãƒ¼ãƒ«': '#f56565',       // èµ¤  
        'ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚º': '#48bb78',  // ç·‘
        'ãƒ©ã‚¤ãƒ–': '#ed8936'        // ã‚ªãƒ¬ãƒ³ã‚¸
      };

      // å„æŠ•ç¨¿ã®è‰²ã‚’æ±ºå®šã™ã‚‹é–¢æ•°
      function getPostTypeColor(postType, alpha = 1) {
        const baseColor = postTypeColors[postType] || '#6b7280'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚°ãƒ¬ãƒ¼
        if (alpha === 1) return baseColor;
        // ã‚¢ãƒ«ãƒ•ã‚¡å€¤ã‚’è€ƒæ…®ã—ãŸè‰²ã‚’è¿”ã™
        const hex = baseColor.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }
      
      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆï¼ˆç·šã‚°ãƒ©ãƒ• + ç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ï¼‰
      const ctx1 = document.getElementById('performanceChart').getContext('2d');
      new Chart(ctx1, {
        data: {
          labels: posts.map(post => {
            const date = new Date(post.date);
            const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
            const title = (post.title && post.title.length > 0) ? post.title : 'æŠ•ç¨¿';
            const genre = post.genre || '';
            const postType = post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰';
            return [dateStr, title, genre, postType];
          }),
          datasets: [{
            type: 'line',
            label: 'ã„ã„ã­æ•°',
            data: posts.map(post => post.likes || 0),
            borderColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰')),
            backgroundColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰', 0.1)),
            borderWidth: 3,
            fill: false,
            tension: 0.4,
            yAxisID: 'y',
            pointBackgroundColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰')),
            pointBorderColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰')),
            pointBorderWidth: 2,
            pointRadius: 6
          }, {
            type: 'line',
            label: 'ä¿å­˜æ•°',
            data: posts.map(post => post.saves || 0),
            borderColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰', 0.7)),
            backgroundColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰', 0.1)),
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false,
            tension: 0.4,
            yAxisID: 'y',
            pointBackgroundColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰', 0.7)),
            pointBorderColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰')),
            pointBorderWidth: 2,
            pointRadius: 4
          }, {
            type: 'bar',
            label: 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒªãƒ¼ãƒ',
            data: posts.map(post => post.reachFollower || 0),
            backgroundColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰', 0.6)),
            borderColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰')),
            borderWidth: 1,
            yAxisID: 'y1',
            stack: 'reach'
          }, {
            type: 'bar',
            label: 'éãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒªãƒ¼ãƒ',
            data: posts.map(post => post.reachNonFollower || 0),
            backgroundColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰', 0.3)),
            borderColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰')),
            borderWidth: 1,
            yAxisID: 'y1',
            stack: 'reach'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: {
              bottom: 40,
              left: 10,
              right: 10
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                generateLabels: function(chart) {
                  const original = Chart.defaults.plugins.legend.labels.generateLabels;
                  const labels = original.call(this, chart);
                  
                  // æŠ•ç¨¿ã‚¿ã‚¤ãƒ—å‡¡ä¾‹ã‚’è¿½åŠ 
                  const postTypeLabels = Object.keys(postTypeColors).map(type => ({
                    text: `${type}æŠ•ç¨¿`,
                    fillStyle: postTypeColors[type],
                    strokeStyle: postTypeColors[type],
                    lineWidth: 2,
                    hidden: false,
                    index: labels.length
                  }));
                  
                  return [...labels, ...postTypeLabels];
                }
              }
            },
            title: {
              display: true,
              text: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç·åˆåˆ†æï¼ˆã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ + ãƒªãƒ¼ãƒï¼‰'
            },
            tooltip: {
              callbacks: {
                afterLabel: function(context) {
                  if (context.dataset.label.includes('ãƒªãƒ¼ãƒ')) {
                    const postIndex = context.dataIndex;
                    const followerReach = posts[postIndex]?.reachFollower || 0;
                    const nonFollowerReach = posts[postIndex]?.reachNonFollower || 0;
                    const totalReach = followerReach + nonFollowerReach;
                    return `åˆè¨ˆãƒªãƒ¼ãƒ: ${totalReach.toLocaleString()}`;
                  }
                  return '';
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                maxRotation: 0,
                minRotation: 0,
                font: {
                  size: 9
                },
                padding: 5,
                autoSkip: false
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæ•°'
              },
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'ãƒªãƒ¼ãƒæ•°'
              },
              beginAtZero: true,
              grid: {
                drawOnChartArea: false,
              },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });



      // ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆï¼ˆè¤‡åˆã‚°ãƒ©ãƒ•ï¼‰
      const ctx4 = document.getElementById('followerChart').getContext('2d');
      
      // ç´¯ç©ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã‚’è¨ˆç®—
      let cumulativeFollowers = <%= company.initial_followers || 0 %>; // é–‹å§‹æ™‚ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°
      const followerData = posts.map(post => {
        cumulativeFollowers += (post.newFollowers || 0);
        return cumulativeFollowers;
      });

      new Chart(ctx4, {
        data: {
          labels: posts.map((post, index) => {
            const date = new Date(post.date);
            const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
            const title = (post.title && post.title.length > 0) ? post.title : 'æŠ•ç¨¿';
            const genre = post.genre || '';
            const postType = post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰';
            return [dateStr, title, genre, postType];
          }),
          datasets: [{
            type: 'line',
            label: 'ç´¯ç©ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°',
            data: followerData,
            borderColor: '#4299e1',
            backgroundColor: 'rgba(66, 153, 225, 0.2)',
            borderWidth: 3,
            fill: true,
            tension: 0.1,
            pointBackgroundColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰')),
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6,
            yAxisID: 'y'
          }, {
            type: 'bar',
            label: 'æœˆé–“æ–°è¦ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼',
            data: posts.map(post => post.newFollowers || 0),
            backgroundColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰', 0.7)),
            borderColor: posts.map(post => getPostTypeColor(post.postType || 'ãƒ•ã‚£ãƒ¼ãƒ‰')),
            borderWidth: 1,
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: {
              bottom: 40,
              left: 10,
              right: 10
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'æŠ•ç¨¿æ—¥'
              },
              ticks: {
                maxRotation: 0,
                minRotation: 0,
                font: {
                  size: 9
                },
                padding: 5,
                autoSkip: false
              }
            },
            y: {
              type: 'linear',
              position: 'left',
              beginAtZero: true,
              title: {
                display: true,
                text: 'ç´¯ç©ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ï¼ˆäººï¼‰'
              },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + 'äºº';
                }
              }
            },
            y1: {
              type: 'linear',
              position: 'right',
              beginAtZero: true,
              title: {
                display: true,
                text: 'æ–°è¦ç²å¾—æ•°ï¼ˆäººï¼‰'
              },
              ticks: {
                callback: function(value) {
                  return '+' + value.toLocaleString() + 'äºº';
                }
              },
              grid: {
                drawOnChartArea: false,
              }
            }
          },
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const datasetLabel = context.dataset.label;
                  const value = context.parsed.y;
                  
                  if (datasetLabel === 'ç´¯ç©ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°') {
                    return `ç´¯ç©ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼: ${value.toLocaleString()}äºº`;
                  } else {
                    return `æ–°è¦ç²å¾—: +${value.toLocaleString()}äºº`;
                  }
                }
              }
            }
          }
        }
      });
    }

    function generateSummary(posts) {
      const totalPosts = posts.length;
      const avgLikes = totalPosts > 0 ? Math.round(posts.reduce((sum, post) => sum + (post.likes || 0), 0) / totalPosts) : 0;
      const bestPost = posts.reduce((max, post) => (post.likes || 0) > (max.likes || 0) ? post : max, posts[0] || {});
      
      const summaryHtml = `
        <div class="bg-blue-50 p-4 rounded-lg">
          <h3 class="font-bold text-blue-800 mb-2">ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒˆãƒ¬ãƒ³ãƒ‰</h3>
          <p>ä»Šæœˆã¯${totalPosts}ä»¶ã®æŠ•ç¨¿ã‚’è¡Œã„ã€å¹³å‡${avgLikes}ã„ã„ã­ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <h3 class="font-bold text-green-800 mb-2">ğŸ† æœ€é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŠ•ç¨¿</h3>
          <p>${bestPost.title || 'æŠ•ç¨¿'} (${bestPost.date}) ãŒ${(bestPost.likes || 0).toLocaleString()}ã„ã„ã­ã§æœ€é«˜ã®åéŸ¿ã‚’å¾—ã¾ã—ãŸã€‚</p>
        </div>
        <div class="bg-yellow-50 p-4 rounded-lg">
          <h3 class="font-bold text-yellow-800 mb-2">ğŸ’¡ æ”¹å–„ææ¡ˆ</h3>
          <p>ç¶™ç¶šçš„ãªæŠ•ç¨¿ã¨ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆå‘ä¸Šã«ã‚ˆã‚Šã€ã•ã‚‰ãªã‚‹æˆé•·ãŒæœŸå¾…ã§ãã¾ã™ã€‚</p>
        </div>
      `;
      
      document.getElementById('summaryComments').innerHTML = summaryHtml;
    }

    function generateNextMonthSuggestions(posts) {
      // ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
      const genreStats = {};
      posts.forEach(post => {
        if (!genreStats[post.genre]) {
          genreStats[post.genre] = { 
            count: 0, 
            totalLikes: 0, 
            totalSaves: 0, 
            totalReach: 0, 
            totalEngagement: 0 
          };
        }
        const stat = genreStats[post.genre];
        stat.count++;
        stat.totalLikes += (post.likes || 0);
        stat.totalSaves += (post.saves || 0);
        stat.totalReach += (post.reachTotal || 0);
        stat.totalEngagement += (post.likes || 0) + (post.saves || 0);
      });

      // æœ€é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ç‰¹å®š
      let bestGenre = '';
      let bestAvgEngagement = 0;
      let worstGenre = '';
      let worstAvgEngagement = Infinity;

      Object.keys(genreStats).forEach(genre => {
        const avgEngagement = genreStats[genre].totalEngagement / genreStats[genre].count;
        if (avgEngagement > bestAvgEngagement) {
          bestAvgEngagement = avgEngagement;
          bestGenre = genre;
        }
        if (avgEngagement < worstAvgEngagement) {
          worstAvgEngagement = avgEngagement;
          worstGenre = genre;
        }
      });

      // æŠ•ç¨¿é »åº¦åˆ†æ
      const totalPosts = posts.length;
      const recommendedPosts = Math.max(8, totalPosts + 2); // æœ€ä½8æŠ•ç¨¿ã€ä»Šæœˆã‚ˆã‚Š2æŠ•ç¨¿å¢—åŠ æ¨å¥¨

      // æ›œæ—¥åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
      const dayStats = {};
      posts.forEach(post => {
        const dayOfWeek = new Date(post.date).getDay();
        const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        const dayName = dayNames[dayOfWeek];
        
        if (!dayStats[dayName]) {
          dayStats[dayName] = { count: 0, totalEngagement: 0 };
        }
        dayStats[dayName].count++;
        dayStats[dayName].totalEngagement += (post.likes || 0) + (post.saves || 0);
      });

      let bestDay = '';
      let bestDayEngagement = 0;
      Object.keys(dayStats).forEach(day => {
        const avgEngagement = dayStats[day].count > 0 ? dayStats[day].totalEngagement / dayStats[day].count : 0;
        if (avgEngagement > bestDayEngagement) {
          bestDayEngagement = avgEngagement;
          bestDay = day;
        }
      });

      // ææ¡ˆç”Ÿæˆ
      const suggestions = [];

      // ã‚¸ãƒ£ãƒ³ãƒ«ææ¡ˆ
      if (bestGenre) {
        suggestions.push({
          icon: 'ğŸ¯',
          title: `${bestGenre}ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å¼·åŒ–`,
          content: `${bestGenre}æŠ•ç¨¿ãŒå¹³å‡${Math.round(bestAvgEngagement)}ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã§æœ€ã‚‚åŠ¹æœçš„ã§ã—ãŸã€‚æ¥æœˆã¯${bestGenre}ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’${Math.ceil(recommendedPosts * 0.4)}æŠ•ç¨¿ï¼ˆå…¨ä½“ã®40%ï¼‰ã«å¢—ã‚„ã™ã“ã¨ã‚’ææ¡ˆã—ã¾ã™ã€‚`,
          priority: 'high'
        });
      }

      // æŠ•ç¨¿é »åº¦ææ¡ˆ
      suggestions.push({
        icon: 'ğŸ“…',
        title: 'æŠ•ç¨¿é »åº¦ã®æœ€é©åŒ–',
        content: `ä»Šæœˆã¯${totalPosts}æŠ•ç¨¿ã§ã—ãŸã€‚ã‚ˆã‚Šå®‰å®šã—ãŸæˆé•·ã®ãŸã‚ã€æ¥æœˆã¯${recommendedPosts}æŠ•ç¨¿ï¼ˆ${Math.ceil(recommendedPosts/7)}æŠ•ç¨¿/é€±ï¼‰ã‚’ç›®æ¨™ã¨ã—ã¾ã—ã‚‡ã†ã€‚`,
        priority: 'medium'
      });

      // æŠ•ç¨¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ææ¡ˆ
      if (bestDay) {
        suggestions.push({
          icon: 'â°',
          title: 'æŠ•ç¨¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®æ´»ç”¨',
          content: `${bestDay}æ›œæ—¥ã®æŠ•ç¨¿ãŒå¹³å‡${Math.round(bestDayEngagement)}ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã§æœ€ã‚‚åå¿œãŒè‰¯ã„ã§ã™ã€‚é‡è¦ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯${bestDay}æ›œæ—¥ã®æŠ•ç¨¿ã‚’å„ªå…ˆã—ã¾ã—ã‚‡ã†ã€‚`,
          priority: 'medium'
        });
      }

      // æ”¹å–„ãŒå¿…è¦ãªã‚¸ãƒ£ãƒ³ãƒ«ã®ææ¡ˆ
      if (worstGenre && Object.keys(genreStats).length > 1) {
        suggestions.push({
          icon: 'ğŸ”„',
          title: `${worstGenre}ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ”¹å–„`,
          content: `${worstGenre}æŠ•ç¨¿ã®å¹³å‡ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆãŒ${Math.round(worstAvgEngagement)}ã¨ä»–ã‚ˆã‚Šä½ã‚ã§ã™ã€‚å†™çœŸã®æ’®å½±è§’åº¦ã‚„ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®å·¥å¤«ã§æ”¹å–„ã‚’å›³ã‚Šã¾ã—ã‚‡ã†ã€‚`,
          priority: 'low'
        });
      }

      // æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å½¢å¼ã®ææ¡ˆ
      const hasReels = posts.some(post => post.postType === 'ãƒªãƒ¼ãƒ«');
      const hasStories = posts.some(post => post.postType === 'ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚º');
      
      if (!hasReels) {
        suggestions.push({
          icon: 'ğŸ¬',
          title: 'ãƒªãƒ¼ãƒ«æŠ•ç¨¿ã®å°å…¥',
          content: 'ä»Šæœˆã¯ãƒªãƒ¼ãƒ«æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒªãƒ¼ãƒ«ã¯ãƒªãƒ¼ãƒæ‹¡å¤§ã«åŠ¹æœçš„ã§ã™ã€‚æ¥æœˆã¯2-3æœ¬ã®ãƒªãƒ¼ãƒ«æŠ•ç¨¿ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
          priority: 'medium'
        });
      }

      if (!hasStories) {
        suggestions.push({
          icon: 'ğŸ“±',
          title: 'ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚ºæ´»ç”¨ã®ææ¡ˆ',
          content: 'æ—¥å¸¸çš„ãªæƒ…å ±ç™ºä¿¡ã«ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚ºã‚’æ´»ç”¨ã—ã€ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã¨ã®è·é›¢ã‚’ç¸®ã‚ã¾ã—ã‚‡ã†ã€‚é€±2-3å›ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚ºæŠ•ç¨¿ã‚’ç›®æ¨™ã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚',
          priority: 'low'
        });
      }

      // ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆå‘ä¸Šæ–½ç­–
      const avgLikes = totalPosts > 0 ? posts.reduce((sum, post) => sum + (post.likes || 0), 0) / totalPosts : 0;
      const avgSaves = totalPosts > 0 ? posts.reduce((sum, post) => sum + (post.saves || 0), 0) / totalPosts : 0;

      if (avgSaves < avgLikes * 0.1) { // ä¿å­˜æ•°ãŒã„ã„ã­æ•°ã®10%æœªæº€ã®å ´åˆ
        suggestions.push({
          icon: 'ğŸ’¾',
          title: 'ä¿å­˜ã•ã‚Œã‚„ã™ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä½œæˆ',
          content: `ä¿å­˜æ•°ãŒå°‘ãªã‚ã§ã™ï¼ˆå¹³å‡${Math.round(avgSaves)}ä¿å­˜ï¼‰ã€‚å½¹ç«‹ã¤æƒ…å ±ã‚„å‚è€ƒã«ãªã‚‹æŠ•ç¨¿ã‚’å¢—ã‚„ã—ã¦ã€ä¿å­˜ç‡å‘ä¸Šã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚`,
          priority: 'medium'
        });
      }

      // HTMLç”Ÿæˆ
      const suggestionsHtml = suggestions.map((suggestion, index) => {
        const priorityColors = {
          high: 'border-red-200 bg-red-50',
          medium: 'border-yellow-200 bg-yellow-50', 
          low: 'border-blue-200 bg-blue-50'
        };
        const priorityLabels = {
          high: 'å„ªå…ˆåº¦: é«˜',
          medium: 'å„ªå…ˆåº¦: ä¸­',
          low: 'å„ªå…ˆåº¦: ä½'
        };
        
        return `
          <div class="p-4 rounded-lg border-2 ${priorityColors[suggestion.priority]}">
            <div class="flex items-start gap-3">
              <span class="text-2xl">${suggestion.icon}</span>
              <div class="flex-1">
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-bold text-gray-800">${suggestion.title}</h3>
                  <span class="text-xs px-2 py-1 rounded-full bg-white bg-opacity-70 text-gray-600">${priorityLabels[suggestion.priority]}</span>
                </div>
                <p class="text-gray-700">${suggestion.content}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // æ¥æœˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ææ¡ˆã‚‚è¿½åŠ 
      const nextMonth = new Date();
      nextMonth.setMonth(nextMonth.getMonth() + 1);
      const nextMonthName = `${nextMonth.getFullYear()}å¹´${nextMonth.getMonth() + 1}æœˆ`;

      const scheduleHtml = `
        <div class="p-4 rounded-lg border-2 border-green-200 bg-green-50 mt-4">
          <div class="flex items-start gap-3">
            <span class="text-2xl">ğŸ“‹</span>
            <div class="flex-1">
              <h3 class="font-bold text-green-800 mb-2">${nextMonthName}ã®æŠ•ç¨¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ¡ˆ</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-green-700">
                <div>â€¢ é€±1-2å›: ${bestGenre || 'å•†å“ç´¹ä»‹'}æŠ•ç¨¿</div>
                <div>â€¢ é€±1å›: ãŠåº—ç´¹ä»‹ãƒ»é›°å›²æ°—æŠ•ç¨¿</div>
                <div>â€¢ é€±1å›: äººç‰©ãƒ»ã‚¹ã‚¿ãƒƒãƒ•ç´¹ä»‹</div>
                <div>â€¢ æœˆ2-3å›: ${hasReels ? 'ãƒªãƒ¼ãƒ«æŠ•ç¨¿ç¶™ç¶š' : 'ãƒªãƒ¼ãƒ«æŠ•ç¨¿ã‚’æ–°è¦é–‹å§‹'}</div>
                <div>â€¢ æ¯æ—¥: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚ºã§ã®æ—¥å¸¸ç™ºä¿¡</div>
                <div>â€¢ ç‰¹åˆ¥ä¼ç”»: ${bestGenre}ã®ç‰¹é›†é€±é–“</div>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('nextMonthSuggestions').innerHTML = suggestionsHtml + scheduleHtml;
    }

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
    function navigateToDataInput() {
      const year = document.getElementById('yearSelect').value;
      const month = document.getElementById('monthSelect').value;
      const company = '<%= company.id %>';
      window.location.href = `/add-post-grid?company=${company}&year=${year}&month=${month}`;
    }

    function navigateToAnalytics() {
      const year = document.getElementById('yearSelect').value;
      const month = document.getElementById('monthSelect').value;
      const company = '<%= company.id %>';
      window.location.href = `/analytics?company=${company}&year=${year}&month=${month}`;
    }
  </script>
</body>
</html>