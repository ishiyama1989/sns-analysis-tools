<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - SNSé‹ç”¨ä»£è¡Œç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - <%= company || 'default' %></h1>
      <nav>
        <a href="/" class="btn btn-link">ãƒ›ãƒ¼ãƒ </a>
        <div class="company-nav-inline">
          <select id="companySelect" onchange="changeCompany()">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
          </select>
        </div>
        <div class="month-selector-nav">
          <label for="yearSelect">å¹´:</label>
          <select id="yearSelect" onchange="changeMonthYear()">
            <% for(let y = 2020; y <= new Date().getFullYear() + 1; y++) { %>
              <option value="<%= y %>" <%= y === (year || new Date().getFullYear()) ? 'selected' : '' %>><%= y %></option>
            <% } %>
          </select>
          <label for="monthSelect">æœˆ:</label>
          <select id="monthSelect" onchange="changeMonthYear()">
            <% for(let m = 1; m <= 12; m++) { %>
              <option value="<%= m %>" <%= m === (month || (new Date().getMonth() + 1)) ? 'selected' : '' %>><%= m %>æœˆ</option>
            <% } %>
          </select>
        </div>
        <a href="#" onclick="navigateToDataInput()" class="btn btn-success">ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</a>
        <a href="#" onclick="navigateToReport()" class="btn btn-primary">ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆ</a>
        <a href="/goals" class="btn btn-link">ç›®æ¨™è¨­å®š</a>
      </nav>
    </header>
    
    <main>
      <% if (posts && posts.length > 0) { %>
        <div class="analytics-summary">
          <div class="summary-card">
            <h3>ç·æŠ•ç¨¿æ•°</h3>
            <span class="summary-number"><%= posts.length %></span>
          </div>
          <div class="summary-card">
            <h3>å¹³å‡ã„ã„ã­æ•°</h3>
            <span class="summary-number">
              <%= Math.round(posts.reduce((sum, post) => sum + (post.likes || 0), 0) / posts.length) %>
            </span>
          </div>
          <div class="summary-card">
            <h3>å¹³å‡ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</h3>
            <span class="summary-number">
              <%= Math.round(posts.reduce((sum, post) => sum + (post.likes || 0) + (post.saves || 0), 0) / posts.length) %>
            </span>
          </div>
          <div class="summary-card">
            <h3>å¹³å‡ãƒªãƒ¼ãƒæ•°</h3>
            <span class="summary-number">
              <%= Math.round(posts.reduce((sum, post) => sum + (post.reach_total || 0), 0) / posts.length) %>
            </span>
          </div>
          <div class="summary-card">
            <h3>æœ€é«˜ã„ã„ã­æ•°</h3>
            <span class="summary-number">
              <%= Math.max(...posts.map(post => post.likes || 0)) %>
            </span>
          </div>
        </div>

        <div class="charts-container">
          <div class="chart-section">
            <div class="chart-header">
              <h2>ã„ã„ã­æ•°æ¨ç§»ï¼ˆæœ€è¿‘30æŠ•ç¨¿ï¼‰</h2>
              <p class="chart-description">æŠ•ç¨¿ã®ã„ã„ã­æ•°ã®æ¨ç§»ã‚’ç¢ºèªã§ãã¾ã™</p>
            </div>
            <div class="chart-container">
              <canvas id="likesChart"></canvas>
            </div>
          </div>

          <div class="chart-section">
            <div class="chart-header">
              <h2>ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ</h2>
              <p class="chart-description">å•†å“ç´¹ä»‹ã€ãŠåº—ç´¹ä»‹ã€äººç‰©ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ</p>
            </div>
            <div class="chart-container">
              <canvas id="genreChart"></canvas>
            </div>
          </div>

          <div class="chart-section">
            <div class="chart-header">
              <h2>ãƒªãƒ¼ãƒåˆ†æï¼ˆãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ vs éãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ï¼‰</h2>
              <p class="chart-description">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã¨éãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®ãƒªãƒ¼ãƒæ•°æ¯”è¼ƒ</p>
            </div>
            <div class="chart-container">
              <canvas id="reachChart"></canvas>
            </div>
          </div>

          <div class="chart-section">
            <div class="chart-header">
              <h2>ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆåˆ†æ</h2>
              <p class="chart-description">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒ»éãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼åˆ¥ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæ¨ç§»</p>
            </div>
            <div class="chart-container">
              <canvas id="engagementChart"></canvas>
            </div>
          </div>
        </div>

        <div class="insights-section">
          <h2>ğŸ“Š åˆ†æã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h2>
          <div class="insights-grid" id="insights">
            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>

      <% } else { %>
        <div class="no-data-message">
          <h2>åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h2>
          <p>æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è©³ç´°ãªåˆ†æã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
          <a href="/add-post" class="btn btn-primary">æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ </a>
        </div>
      <% } %>
    </main>
  </div>

  <script>
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚°ãƒ©ãƒ•ã‚’åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      await loadCompanyList();
      <% if (posts && posts.length > 0) { %>
        initializeCharts();
      <% } %>
    });

    async function initializeCharts() {
      try {
        const company = document.getElementById('companySelect').value;
        const year = document.getElementById('yearSelect').value;
        const month = document.getElementById('monthSelect').value;
        const response = await fetch(`/api/analytics-data?company=${company}&year=${year}&month=${month}`);
        const data = await response.json();
        
        createLikesChart(data.likesOverTime);
        createGenreChart(data.genreComparison);
        createReachChart(data.reachAnalysis);
        createEngagementChart(data.engagementAnalysis);
        generateInsights(data);
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      }
    }
    
    function changeCompany() {
      const company = document.getElementById('companySelect').value;
      const year = document.getElementById('yearSelect').value;
      const month = document.getElementById('monthSelect').value;
      window.location.href = `/analytics?company=${company}&year=${year}&month=${month}`;
    }
    
    function changeMonthYear() {
      const company = document.getElementById('companySelect').value;
      const year = document.getElementById('yearSelect').value;
      const month = document.getElementById('monthSelect').value;
      window.location.href = `/analytics?company=${company}&year=${year}&month=${month}`;
    }
    
    // ä¼šç¤¾ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¨­å®š
    async function loadCompanyList() {
      try {
        const response = await fetch('/api/companies');
        const companies = await response.json();
        
        const companySelect = document.getElementById('companySelect');
        companySelect.innerHTML = '<option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>';
        
        companies.forEach(company => {
          const option = document.createElement('option');
          option.value = company.id;
          option.textContent = company.company_name;
          option.selected = company.id === '<%= company || "default" %>';
          companySelect.appendChild(option);
        });
      } catch (error) {
        console.error('ä¼šç¤¾ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
      }
    }

    // ã„ã„ã­æ•°æ¨ç§»ã‚°ãƒ©ãƒ•
    function createLikesChart(data) {
      const ctx = document.getElementById('likesChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'ã„ã„ã­æ•°',
            data: data.data,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            }
          }
        }
      });
    }

    // ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥æ¯”è¼ƒã‚°ãƒ©ãƒ•
    function createGenreChart(data) {
      const ctx = document.getElementById('genreChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'å¹³å‡ã„ã„ã­æ•°',
            data: data.avgLikes,
            backgroundColor: ['#FF6B6B', '#4ECDC4', '#45B7D1'],
            borderRadius: 8,
            borderSkipped: false,
          }, {
            label: 'å¹³å‡ä¿å­˜æ•°',
            data: data.avgSaves,
            backgroundColor: ['#FFA726', '#66BB6A', '#AB47BC'],
            borderRadius: 8,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // ãƒªãƒ¼ãƒåˆ†æã‚°ãƒ©ãƒ•
    function createReachChart(data) {
      const ctx = document.getElementById('reachChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒªãƒ¼ãƒ',
            data: data.followerReach,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: false,
            tension: 0.4
          }, {
            label: 'éãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒªãƒ¼ãƒ',
            data: data.nonFollowerReach,
            borderColor: '#f093fb',
            backgroundColor: 'rgba(240, 147, 251, 0.1)',
            borderWidth: 3,
            fill: false,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            }
          }
        }
      });
    }

    // ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆåˆ†æã‚°ãƒ©ãƒ•
    function createEngagementChart(data) {
      const ctx = document.getElementById('engagementChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ENG',
            data: data.followerEng,
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderRadius: 4,
            borderSkipped: false,
          }, {
            label: 'éãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ENG',
            data: data.nonFollowerEng,
            backgroundColor: 'rgba(240, 147, 251, 0.8)',
            borderRadius: 4,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: {
                display: false
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            }
          }
        }
      });
    }

    // ã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆ
    function generateInsights(data) {
      const insights = [];
      
      // æœ€è‰¯ã‚¸ãƒ£ãƒ³ãƒ«ã®åˆ†æ
      if (data.genreComparison.avgLikes.length > 0) {
        const maxGenreIndex = data.genreComparison.avgLikes.indexOf(Math.max(...data.genreComparison.avgLikes));
        const bestGenre = data.genreComparison.labels[maxGenreIndex];
        insights.push({
          icon: 'ğŸ“ˆ',
          title: 'åŠ¹æœçš„ãªã‚¸ãƒ£ãƒ³ãƒ«',
          content: `${bestGenre}æŠ•ç¨¿ãŒå¹³å‡${data.genreComparison.avgLikes[maxGenreIndex]}ã„ã„ã­ã‚’ç²å¾—ã—ã¦ã„ã¾ã™ã€‚`
        });
      }

      // ãƒªãƒ¼ãƒåˆ†æ
      if (data.reachAnalysis.followerReach.length > 0 && data.reachAnalysis.nonFollowerReach.length > 0) {
        const totalFollowerReach = data.reachAnalysis.followerReach.reduce((a, b) => a + b, 0);
        const totalNonFollowerReach = data.reachAnalysis.nonFollowerReach.reduce((a, b) => a + b, 0);
        const nonFollowerRatio = Math.round((totalNonFollowerReach / (totalFollowerReach + totalNonFollowerReach)) * 100);
        
        insights.push({
          icon: 'ğŸ¯',
          title: 'ãƒªãƒ¼ãƒåˆ†æ',
          content: `éãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã‹ã‚‰ã®ãƒªãƒ¼ãƒãŒ${nonFollowerRatio}%ã‚’å ã‚ã¦ã„ã¾ã™ã€‚æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®éœ²å‡ºãŒè‰¯å¥½ã§ã™ã€‚`
        });
      }

      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒˆãƒ¬ãƒ³ãƒ‰
      if (data.likesOverTime.data.length >= 5) {
        const recent5 = data.likesOverTime.data.slice(-5);
        const previous5 = data.likesOverTime.data.slice(-10, -5);
        const recentAvg = recent5.reduce((a, b) => a + b, 0) / recent5.length;
        const previousAvg = previous5.reduce((a, b) => a + b, 0) / previous5.length;
        
        if (recentAvg > previousAvg) {
          insights.push({
            icon: 'ğŸš€',
            title: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š',
            content: `æœ€è¿‘ã®æŠ•ç¨¿ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒ${Math.round(((recentAvg - previousAvg) / previousAvg) * 100)}%å‘ä¸Šã—ã¦ã„ã¾ã™ã€‚`
          });
        } else if (recentAvg < previousAvg) {
          insights.push({
            icon: 'ğŸ“‰',
            title: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹',
            content: `æœ€è¿‘ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒ${Math.round(((previousAvg - recentAvg) / previousAvg) * 100)}%ä½ä¸‹ã—ã¦ã„ã¾ã™ã€‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`
          });
        }
      }

      // ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆåˆ†æ
      if (data.engagementAnalysis.followerEng.length > 0) {
        const avgFollowerEng = data.engagementAnalysis.followerEng.reduce((a, b) => a + b, 0) / data.engagementAnalysis.followerEng.length;
        const avgNonFollowerEng = data.engagementAnalysis.nonFollowerEng.reduce((a, b) => a + b, 0) / data.engagementAnalysis.nonFollowerEng.length;
        
        if (avgNonFollowerEng > avgFollowerEng) {
          insights.push({
            icon: 'âœ¨',
            title: 'ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆåˆ†æ',
            content: `éãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã‹ã‚‰ã®ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆãŒé«˜ãã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ‹¡æ•£æ€§ãŒè‰¯å¥½ã§ã™ã€‚`
          });
        } else {
          insights.push({
            icon: 'ğŸ’ª',
            title: 'ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆåˆ†æ',
            content: `æ—¢å­˜ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã‹ã‚‰ã®åå¿œãŒè‰¯å¥½ã§ã™ã€‚ç¶™ç¶šçš„ãªé–¢ä¿‚æ§‹ç¯‰ãŒã§ãã¦ã„ã¾ã™ã€‚`
          });
        }
      }

      // ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’è¡¨ç¤º
      const insightsContainer = document.getElementById('insights');
      insightsContainer.innerHTML = insights.map(insight => `
        <div class="insight-card">
          <div class="insight-icon">${insight.icon}</div>
          <h3>${insight.title}</h3>
          <p>${insight.content}</p>
        </div>
      `).join('');
    }

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
    function navigateToDataInput() {
      const company = document.getElementById('companySelect').value;
      const year = document.getElementById('yearSelect').value;
      const month = document.getElementById('monthSelect').value;
      window.location.href = `/add-post-grid?company=${company}&year=${year}&month=${month}`;
    }

    function navigateToReport() {
      const company = document.getElementById('companySelect').value;
      const year = document.getElementById('yearSelect').value;
      const month = document.getElementById('monthSelect').value;
      window.location.href = `/report/${company}?year=${year}&month=${month}`;
    }
  </script>
</body>
</html>